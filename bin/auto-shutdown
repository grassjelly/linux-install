#!/bin/bash

# Configuration
CPU_THRESHOLD=5
IDLE_MINUTES=30
FILE_ACTIVITY_MINUTES=120  # Threshold for file activity in ~/.claude/projects
LOG_FILE="/var/log/auto-shutdown.log"
PROJECTS_DIR="$HOME/.claude/projects"
HARD_SHUTDOWN_HOUR=1  # 1 AM SGT

# Function to log with timestamp
log_message() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

log_message "=== Idle check starting ==="

# Check for hard shutdown time (1 AM SGT = UTC+8)
CURRENT_HOUR_SGT=$(TZ='Asia/Singapore' date '+%H')
CURRENT_MINUTE_SGT=$(TZ='Asia/Singapore' date '+%M')
log_message "Current time SGT: ${CURRENT_HOUR_SGT}:${CURRENT_MINUTE_SGT}"

if [ "$CURRENT_HOUR_SGT" -eq "$HARD_SHUTDOWN_HOUR" ] && [ "$CURRENT_MINUTE_SGT" -lt 5 ]; then
  log_message "!!! HARD SHUTDOWN TRIGGERED - Scheduled 1 AM SGT shutdown !!!"
  logger -t auto-shutdown "Hard shutdown at 1 AM SGT"
  sudo shutdown -h now
  exit 0
fi

# Get CPU usage
CPU_USAGE=$(top -bn2 -d 0.5 | grep "Cpu(s)" | tail -1 | awk '{print $2}' | cut -d'%' -f1)
log_message "Current CPU usage: ${CPU_USAGE}%"

# Check file activity in ~/.claude/projects
FILE_ACTIVITY_IDLE=true
if [ -d "$PROJECTS_DIR" ]; then
  # Get the newest file's modification time
  NEWEST_FILE=$(ls -lt "$PROJECTS_DIR" 2>/dev/null | grep -v '^total' | grep -v '^d' | head -1 | awk '{for(i=9;i<=NF;i++) printf "%s ", $i; print ""}' | sed 's/ $//')

  if [ -n "$NEWEST_FILE" ]; then
    NEWEST_FILE_PATH="$PROJECTS_DIR/$NEWEST_FILE"
    if [ -e "$NEWEST_FILE_PATH" ]; then
      LAST_MODIFIED=$(stat -c %Y "$NEWEST_FILE_PATH" 2>/dev/null)
      NOW=$(date +%s)
      MINUTES_SINCE_MODIFIED=$(( ($NOW - $LAST_MODIFIED) / 60 ))

      log_message "Newest file in projects: $NEWEST_FILE (modified ${MINUTES_SINCE_MODIFIED} minutes ago)"

      if [ $MINUTES_SINCE_MODIFIED -le $FILE_ACTIVITY_MINUTES ]; then
        FILE_ACTIVITY_IDLE=false
        log_message "Recent file activity detected - system not idle"
      else
        log_message "No recent file activity (threshold: ${FILE_ACTIVITY_MINUTES} minutes)"
      fi
    fi
  else
    log_message "No files found in projects directory"
  fi
else
  log_message "Projects directory does not exist: $PROJECTS_DIR"
fi

# Store timestamp of last activity based on CPU or file activity
if (( $(echo "$CPU_USAGE > $CPU_THRESHOLD" | bc -l) )) || [ "$FILE_ACTIVITY_IDLE" = false ]; then
  date +%s > /tmp/last_activity
  log_message "System active - resetting idle timer"
else
  log_message "System below activity threshold"
fi

# Check if idle long enough
if [ -f /tmp/last_activity ]; then
  LAST_ACTIVE=$(cat /tmp/last_activity)
  NOW=$(date +%s)
  IDLE_TIME=$(( ($NOW - $LAST_ACTIVE) / 60 ))

  log_message "Idle for ${IDLE_TIME} minutes (threshold: ${IDLE_MINUTES} minutes)"

  if [ $IDLE_TIME -gt $IDLE_MINUTES ]; then
    log_message "!!! SHUTDOWN TRIGGERED - Idle time exceeded threshold !!!"
    logger -t auto-shutdown "Shutting down due to ${IDLE_TIME} minutes of inactivity"
    sudo shutdown -h now
  fi
else
  log_message "No activity file found - creating new baseline"
  date +%s > /tmp/last_activity
fi
